<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Employment Club</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Caveat:wght@400;500;600;700&family=Inter:wght@300;400;500;600&family=Lora:ital,wght@0,400;0,500;1,400&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #f5f0eb;
            --text: #1a1a1a;
            --muted: #8a8178;
            --sans: 'Inter', system-ui, -apple-system, sans-serif;
            --serif: 'Lora', Georgia, serif;
            --hand: 'Caveat', cursive;
            --ease-out: cubic-bezier(0.16, 1, 0.3, 1);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; user-select: none; -webkit-user-drag: none; }

        body {
            background: var(--bg);
            color: var(--text);
            font-family: var(--sans);
            overflow: hidden;
            overscroll-behavior: none;
            width: 100vw; height: 100vh;
            cursor: grab;
        }

        body.is-dragging { cursor: grabbing !important; }
        body.is-dragging * { cursor: grabbing !important; }

        /* --- UI Overlay --- */
        .ui-overlay {
            position: fixed; bottom: 0; right: 0;
            z-index: 200; pointer-events: none;
            padding: 1.5rem;
            display: flex; gap: 8px; align-items: center;
        }

        .ui-btn {
            pointer-events: auto;
            background: rgba(255, 255, 255, 0.65);
            backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(0,0,0,0.05);
            border-radius: 10px;
            padding: 8px 14px;
            font-family: var(--sans);
            font-size: 0.72rem; font-weight: 600;
            color: var(--text); cursor: pointer;
            transition: all 0.25s var(--ease-out);
            display: flex; align-items: center; gap: 6px;
            font-variant-numeric: tabular-nums;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05), inset 0 0 0 1px rgba(255,255,255,0.4);
        }
        .ui-btn:hover {
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 6px 20px rgba(0,0,0,0.08), inset 0 0 0 1px rgba(255,255,255,0.5);
        }
        .ui-btn svg {
            width: 13px; height: 13px; fill: none;
            stroke: currentColor; stroke-width: 2;
            stroke-linecap: round; stroke-linejoin: round;
        }
        a.ui-btn { text-decoration: none; }

        /* Subtle login icon — bottom-right corner */
        .corner-secret {
            position: fixed; bottom: 12px; right: 12px;
            z-index: 999;
            width: 28px; height: 28px;
            display: flex; align-items: center; justify-content: center;
            font-size: 0.7rem;
            color: rgba(0,0,0,0.08);
            text-decoration: none;
            border-radius: 6px;
            transition: color 0.3s ease, background 0.3s ease;
        }
        .corner-secret:hover {
            color: rgba(0,0,0,0.3);
            background: rgba(0,0,0,0.03);
        }

        /* --- Viewport & Canvas --- */
        .viewport {
            width: 100vw; height: 100vh;
            position: absolute; top: 0; left: 0;
            background: radial-gradient(ellipse at center, #f8f4ef 0%, #ece5db 100%);
        }

        .canvas {
            position: absolute; top: 50%; left: 50%;
            will-change: transform;
        }
        .canvas.is-animating { transition: transform 0.5s var(--ease-out); }
        .canvas.is-zooming { transition: transform 0.12s cubic-bezier(0.2, 0, 0.2, 1); }

        /* Crisp dot grid */
        .canvas-bg {
            position: absolute;
            top: -10000px; left: -10000px;
            width: 20000px; height: 20000px;
            background-image: radial-gradient(circle, rgba(0,0,0,0.07) 1px, transparent 1px);
            background-size: 48px 48px;
            z-index: -1; pointer-events: none;
        }

        /* --- Center Hub --- */
        .center-hub {
            position: absolute; top: 0; left: 0;
            transform: translate(-50%, -50%);
            display: flex; flex-direction: column; align-items: center;
            text-align: center; width: 400px; z-index: 10;
            pointer-events: none;
            opacity: 0;
            animation: fadeInHub 1s 0.15s var(--ease-out) forwards;
            transition: opacity 0.4s ease;
        }

        .center-hub > * { pointer-events: auto; }

        .center-logo {
            width: 180px; height: auto;
            margin-bottom: 1rem;
            filter: drop-shadow(0 4px 12px rgba(0,0,0,0.04)) drop-shadow(0 20px 40px rgba(0,0,0,0.06));
            transition: transform 0.4s var(--ease-out);
        }
        .center-logo:hover { transform: scale(1.03); }

        .divider {
            width: 24px; height: 2px;
            background: #d4cfc9; border-radius: 2px;
            margin-bottom: 1.8rem;
        }

        .mission-desc {
            font-family: var(--serif); font-style: italic;
            font-size: 0.75rem; line-height: 1.6;
            color: rgba(0,0,0,0.45); max-width: 360px;
            letter-spacing: 0.1px; font-weight: 400;
            margin-bottom: 0;
        }

        .mission-attribution {
            font-family: var(--hand);
            font-size: 1.05rem;
            color: rgba(0,0,0,0.3);
            text-decoration: none;
            margin-top: 0.6rem;
            display: inline-block;
            transition: color 0.2s ease;
        }
        .mission-attribution:hover { color: rgba(0,0,0,0.55); }

        /* Members — clean editorial comma list */
        .members-label {
            font-family: var(--serif); font-style: italic;
            font-size: 0.75rem; font-weight: 400;
            letter-spacing: 0.1px;
            color: rgba(0,0,0,0.35); margin-bottom: 0.5rem;
        }

        .members-list {
            display: inline-flex; flex-wrap: wrap;
            justify-content: center; max-width: 400px;
            gap: 0;
        }

        .member {
            font-size: 0.82rem; color: var(--muted);
            padding: 0; background: none; border-radius: 0;
            text-decoration: none;
            transition: color 0.2s ease;
        }
        a.member { cursor: pointer; }
        .member:hover { color: var(--text); }
        .member-sep {
            font-size: 0.82rem; color: rgba(0,0,0,0.15);
            margin: 0 8px;
        }

        /* --- Floating Objects --- */
        .float-obj {
            position: absolute;
            opacity: 0;
            animation: enterObj 0.9s var(--ease-out) forwards;
            cursor: inherit;
            filter: drop-shadow(0 4px 12px rgba(0,0,0,0.04)) drop-shadow(0 20px 40px rgba(0,0,0,0.06));
            transition: filter 0.4s var(--ease-out), opacity 0.3s ease;
            will-change: transform, filter;
        }

        .float-obj:hover {
            z-index: 50;
            filter: drop-shadow(0 12px 24px rgba(0,0,0,0.06)) drop-shadow(0 32px 64px rgba(0,0,0,0.1));
        }

        /* Dim siblings on hover */
        #objects-container:hover .float-obj { opacity: 0.4; }
        #objects-container:hover .float-obj:hover { opacity: 1; }

        .float-img {
            width: 100%; height: auto; display: block;
            pointer-events: none;
            transition: transform 0.5s var(--ease-out);
        }
        .float-obj:hover .float-img {
            transform: rotate(1.5deg);
        }

        /* Etched-in-canvas label — title always visible, meta on hover */
        .float-info {
            position: relative;
            text-align: center;
            padding-top: 10px;
            pointer-events: none;
        }
        .float-info a { pointer-events: auto; }

        .float-title {
            font-family: var(--hand);
            font-size: 1.05rem; font-weight: 600;
            color: rgba(0,0,0,0.45);
            line-height: 1.1;
            transition: color 0.3s ease;
        }
        .float-obj:hover .float-title { color: rgba(0,0,0,0.65); }

        .float-meta {
            display: flex; align-items: center; justify-content: center; gap: 5px;
            margin-top: 2px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .float-obj:hover .float-meta { opacity: 1; }

        .float-desc {
            font-family: var(--sans);
            font-size: 0.55rem; font-weight: 500;
            color: rgba(0,0,0,0.25); letter-spacing: 0.2px;
        }

        .float-dot {
            width: 2px; height: 2px;
            border-radius: 50%; background: rgba(0,0,0,0.15);
            flex-shrink: 0;
        }

        .float-creator {
            font-family: var(--sans);
            font-size: 0.55rem; font-weight: 600;
            color: rgba(0,0,0,0.25);
            text-decoration: none;
        }
        a.float-creator:hover { color: rgba(0,0,0,0.45); }

        .float-link {
            display: inline-flex; align-items: center; gap: 3px;
            font-family: var(--sans);
            font-size: 0.5rem; font-weight: 600;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            color: rgba(0,0,0,0.15);
            text-decoration: none;
            margin-top: 5px;
            opacity: 0;
            transition: opacity 0.3s ease, color 0.2s ease;
        }
        .float-obj:hover .float-link { opacity: 1; }
        .float-link:hover { color: rgba(0,0,0,0.5); }
        .float-link svg { width: 8px; height: 8px; stroke: currentColor; fill: none; stroke-width: 2.5; }

        /* --- Owner Controls --- */
        .owner-controls {
            position: absolute;
            top: 6px; right: 6px;
            display: flex; gap: 4px;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: auto;
            z-index: 5;
        }
        .float-obj:hover .owner-controls { opacity: 1; }

        .owner-btn {
            width: 26px; height: 26px;
            border-radius: 8px; border: none;
            background: rgba(255,255,255,0.85);
            backdrop-filter: blur(8px);
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.2s ease;
            box-shadow: 0 2px 6px rgba(0,0,0,0.08);
        }
        .owner-btn:hover { background: #fff; transform: scale(1.08); }
        .owner-btn svg {
            width: 12px; height: 12px;
            stroke: rgba(0,0,0,0.4); fill: none;
            stroke-width: 2; stroke-linecap: round; stroke-linejoin: round;
        }
        .owner-btn.delete-btn:hover svg { stroke: #c0365e; }

        /* --- Edit Modal --- */
        .edit-overlay {
            position: fixed; inset: 0;
            background: rgba(0,0,0,0.25);
            backdrop-filter: blur(4px);
            z-index: 500;
            display: flex; align-items: center; justify-content: center;
            padding: 1.5rem; cursor: default;
        }
        .edit-modal {
            background: var(--bg);
            border-radius: 18px; padding: 2rem;
            width: 100%; max-width: 420px;
            box-shadow: 0 24px 80px rgba(0,0,0,0.15);
            user-select: auto;
        }
        .edit-header {
            font-family: var(--serif);
            font-size: 1.2rem; font-weight: 400; font-style: italic;
            margin-bottom: 1.5rem; text-align: center;
        }
        .edit-field { margin-bottom: 1rem; }
        .edit-field label {
            display: block;
            font-size: 0.72rem; font-weight: 600;
            color: var(--muted); margin-bottom: 0.4rem;
            letter-spacing: 0.3px;
        }
        .edit-field input[type="text"],
        .edit-field textarea {
            width: 100%; padding: 10px 14px;
            border: 1px solid rgba(0,0,0,0.08);
            border-radius: 10px;
            background: rgba(255,255,255,0.6);
            font-family: var(--sans); font-size: 0.88rem;
            color: var(--text); outline: none;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
            user-select: auto;
        }
        .edit-field input:focus,
        .edit-field textarea:focus {
            border-color: rgba(0,0,0,0.15);
            box-shadow: 0 0 0 3px rgba(0,0,0,0.03);
        }
        .edit-field textarea { resize: vertical; min-height: 60px; line-height: 1.5; }
        .edit-image-row { display: flex; align-items: center; gap: 12px; }
        .edit-thumb {
            width: 56px; height: 56px;
            border-radius: 8px; object-fit: cover;
            background: linear-gradient(135deg, #e0d5c9, #c4b8ab);
            flex-shrink: 0;
        }
        .edit-change-btn {
            font-family: var(--sans);
            font-size: 0.72rem; font-weight: 600;
            color: var(--muted);
            background: rgba(255,255,255,0.5);
            border: 1px dashed rgba(0,0,0,0.08);
            border-radius: 8px; padding: 6px 14px;
            cursor: pointer; transition: all 0.2s ease;
        }
        .edit-change-btn:hover { background: rgba(255,255,255,0.8); }
        .edit-actions { display: flex; gap: 8px; margin-top: 1.5rem; }
        .edit-cancel, .edit-save {
            flex: 1; padding: 10px; border-radius: 12px;
            font-family: var(--sans); font-size: 0.82rem; font-weight: 600;
            cursor: pointer; transition: all 0.2s ease;
        }
        .edit-cancel {
            border: 1px solid rgba(0,0,0,0.08);
            background: transparent; color: var(--muted);
        }
        .edit-cancel:hover { background: rgba(255,255,255,0.5); }
        .edit-save {
            border: none; background: var(--text); color: #f5f0eb;
        }
        .edit-save:hover { background: #333; }
        .edit-save:disabled { opacity: 0.4; cursor: not-allowed; }

        /* --- Mobile --- */
        @media (max-width: 600px) {
            .center-logo { width: 120px; margin-bottom: 0.6rem; }
            .center-hub { width: 300px; }
            .members-label { font-size: 0.65rem; margin-bottom: 0.3rem; }
            .member { font-size: 0.72rem; }
            .member-sep { font-size: 0.72rem; margin: 0 5px; }
            .mission-desc { font-size: 0.65rem; max-width: 260px; }
            .mission-attribution { font-size: 0.9rem; }
            .ui-btn { padding: 6px 10px; font-size: 0.65rem; }

            /* Hint arrow to explore */
            .explore-hint {
                position: fixed; bottom: 5rem; left: 50%;
                transform: translateX(-50%);
                display: flex; flex-direction: column; align-items: center; gap: 4px;
                z-index: 100; pointer-events: none;
                animation: hintPulse 2.5s ease-in-out infinite;
            }
            .explore-hint span {
                font-family: var(--sans);
                font-size: 0.6rem; font-weight: 600;
                letter-spacing: 0.5px; text-transform: uppercase;
                color: rgba(0,0,0,0.2);
            }
            .explore-hint svg {
                width: 18px; height: 18px;
                stroke: rgba(0,0,0,0.15); fill: none;
                stroke-width: 2; stroke-linecap: round; stroke-linejoin: round;
            }
        }
        @media (min-width: 601px) {
            .explore-hint { display: none; }
        }

        @keyframes hintPulse {
            0%, 100% { opacity: 0.6; transform: translateX(-50%) translateY(0); }
            50% { opacity: 1; transform: translateX(-50%) translateY(4px); }
        }

        /* --- Animations --- */
        @keyframes fadeInHub {
            0% { opacity: 0; transform: translate(-50%, -46%) scale(0.94); }
            100% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        }

        @keyframes enterObj {
            0% { opacity: 0; transform: translate(var(--tx), var(--ty)) rotate(var(--rot)) scale(0.85); }
            100% { opacity: 1; transform: translate(var(--tx), var(--ty)) rotate(var(--rot)) scale(1); }
        }
    </style>
</head>
<body>

    <a href="submit.html" class="corner-secret" id="corner-secret" title="Sign in">&#9679;</a>
    <div class="ui-overlay">
        <div class="ui-btn" id="zoom-display">100%</div>
        <div class="ui-btn" id="center-btn" title="Back to center">
            <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M12 2v4M12 18v4M2 12h4M18 12h4"/></svg>
            Center
        </div>
    </div>

    <div class="explore-hint" id="explore-hint">
        <span>Drag to explore</span>
        <svg viewBox="0 0 24 24"><path d="M5 9l7 7 7-7"/></svg>
    </div>

    <div class="viewport" id="viewport">
        <div class="canvas" id="canvas">
            <div class="canvas-bg"></div>

            <div class="center-hub" id="center-hub">
                <img src="logo.png" alt="Employment Club" class="center-logo">
                <div class="members-label">Members</div>
                <div class="members-list" id="members-list"></div>
                <p class="mission-desc" style="margin-top: 1.2rem;">This club is a space for my friends to work on projects together and put their work out to help land a job. Everyone here is incredibly talented, a tinkerer at heart, and attends the ITP program at NYU.</p>
                <a class="mission-attribution" href="https://surya.website" target="_blank">— Surya</a>
            </div>

            <div id="objects-container"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const SUPABASE_URL = 'https://pqzyhiyohiruvkjtqsii.supabase.co';
        const SUPABASE_KEY = 'sb_publishable__I5kMfVhw4D-LIfJiAdZMg_MZdj-ixV';

        let sb = null;
        try { sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY); } catch(e) {}

        const container = document.getElementById('objects-container');
        const membersList = document.getElementById('members-list');
        let currentUserId = null;
        const projectsData = new Map();
        let editImageFile = null;

        // Render members list
        function renderMembers(members) {
            membersList.innerHTML = '';
            members.forEach((m, i) => {
                const name = typeof m === 'string' ? m : m.name;
                const website = typeof m === 'string' ? null : m.website;
                if (website) {
                    const el = document.createElement('a');
                    el.className = 'member';
                    el.href = safeUrl(website);
                    el.target = '_blank';
                    el.rel = 'noopener noreferrer';
                    el.textContent = name;
                    membersList.appendChild(el);
                } else {
                    const el = document.createElement('span');
                    el.className = 'member';
                    el.textContent = name;
                    membersList.appendChild(el);
                }
                if (i < members.length - 1) {
                    const sep = document.createElement('span');
                    sep.className = 'member-sep';
                    sep.textContent = '\u00b7';
                    membersList.appendChild(sep);
                }
            });
        }

        // Escape HTML to prevent XSS
        function esc(str) {
            const d = document.createElement('div');
            d.textContent = str;
            return d.innerHTML;
        }

        // Sanitize URLs — only allow http/https
        function safeUrl(url) {
            if (!url) return '';
            const u = url.trim();
            if (u.startsWith('http://') || u.startsWith('https://')) return u;
            if (u.startsWith('javascript:') || u.startsWith('data:')) return '';
            return 'https://' + u;
        }

        // Render a single floating object on the canvas
        function renderObject(obj, delay, skipAnim) {
            const el = document.createElement('div');
            el.className = 'float-obj';
            if (obj.id) {
                el.dataset.id = obj.id;
                projectsData.set(obj.id, obj);
            }
            el.style.width = (obj.w || obj.width || 250) + 'px';
            const x = obj.x || obj.canvas_x || 0;
            const y = obj.y || obj.canvas_y || 0;
            const rot = obj.rot || obj.rotation || 0;
            el.style.setProperty('--tx', x + 'px');
            el.style.setProperty('--ty', y + 'px');
            el.style.setProperty('--rot', rot + 'deg');
            el.style.left = -(obj.w || obj.width || 250) / 2 + 'px';
            el.style.top = '-80px';
            el.style.transform = `translate(${x}px, ${y}px) rotate(${rot}deg)`;
            el.style.animationDelay = delay + 's';
            if (skipAnim) { el.style.animation = 'none'; el.style.opacity = '1'; }

            const imgSrc = esc(obj.img || obj.image_url || '');
            const title = esc(obj.title || '');
            const desc = esc(obj.desc || obj.description || '');
            const creator = esc(obj.creator || obj.member_name || '');
            const url = safeUrl(obj.url || obj.project_url || '');
            const creatorWebsite = safeUrl(obj.creator_website || '');
            const isOwner = currentUserId && obj.member_id === currentUserId;

            const ownerHtml = isOwner ? `
                <div class="owner-controls">
                    <button class="owner-btn edit-btn" title="Edit">
                        <svg viewBox="0 0 24 24"><path d="M17 3a2.85 2.85 0 114 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>
                    </button>
                    <button class="owner-btn delete-btn" title="Delete">
                        <svg viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>
                    </button>
                </div>` : '';

            const linkHtml = url ? `<a class="float-link" href="${url}" target="_blank" rel="noopener noreferrer">View project <svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><line x1="7" y1="17" x2="17" y2="7"/><polyline points="7 7 17 7 17 17"/></svg></a>` : '';

            const creatorHtml = creatorWebsite
                ? `<a class="float-creator" href="${creatorWebsite}" target="_blank" rel="noopener noreferrer">${creator}</a>`
                : `<span class="float-creator">${creator}</span>`;

            el.innerHTML = `
                ${ownerHtml}
                <img class="float-img" src="${imgSrc}" alt="${title}">
                <div class="float-info">
                    <div class="float-title">${title}</div>
                    <div class="float-meta">
                        <span class="float-desc">${desc}</span>
                        <span class="float-dot"></span>
                        ${creatorHtml}
                    </div>
                    ${linkHtml}
                </div>
            `;

            if (isOwner) {
                el.querySelector('.edit-btn').addEventListener('click', (e) => { e.stopPropagation(); openEditModal(obj.id); });
                el.querySelector('.delete-btn').addEventListener('click', (e) => { e.stopPropagation(); deleteProject(obj.id); });
            }

            container.appendChild(el);
            return el;
        }

        // Load data from Supabase
        async function loadData() {
            if (!sb) return;

            try {
                // Fetch members
                const { data: dbMembers } = await sb.from('members').select('name, website').order('name');
                if (dbMembers && dbMembers.length > 0) {
                    renderMembers(dbMembers);
                }

                // Fetch projects with member info
                const { data: dbProjects } = await sb
                    .from('projects')
                    .select('*, members(name, website)')
                    .order('created_at');

                if (dbProjects && dbProjects.length > 0) {
                    dbProjects.forEach((p, i) => {
                        renderObject({
                            id: p.id,
                            member_id: p.member_id,
                            img: p.image_url,
                            title: p.title,
                            desc: p.description,
                            url: p.project_url,
                            creator: p.members?.name || '',
                            creator_website: p.members?.website || '',
                            w: p.width,
                            x: p.canvas_x,
                            y: p.canvas_y,
                            rot: p.rotation
                        }, 0.3 + i * 0.06);
                    });
                }
            } catch(e) {
                console.log('Supabase fetch failed', e);
            }

            // Subscribe to realtime changes
            sb.channel('projects-realtime')
                .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'projects' }, async (payload) => {
                    const p = payload.new;
                    const { data: member } = await sb.from('members').select('name, website').eq('id', p.member_id).single();
                    renderObject({
                        id: p.id,
                        member_id: p.member_id,
                        img: p.image_url,
                        title: p.title,
                        desc: p.description,
                        url: p.project_url,
                        creator: member?.name || '',
                        creator_website: member?.website || '',
                        w: p.width,
                        x: p.canvas_x,
                        y: p.canvas_y,
                        rot: p.rotation
                    }, 0);
                })
                .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'projects' }, async (payload) => {
                    const p = payload.new;
                    const oldEl = container.querySelector('[data-id="' + p.id + '"]');
                    if (oldEl) oldEl.remove();
                    const { data: member } = await sb.from('members').select('name, website').eq('id', p.member_id).single();
                    renderObject({
                        id: p.id,
                        member_id: p.member_id,
                        img: p.image_url,
                        title: p.title,
                        desc: p.description,
                        url: p.project_url,
                        creator: member?.name || '',
                        creator_website: member?.website || '',
                        w: p.width,
                        x: p.canvas_x,
                        y: p.canvas_y,
                        rot: p.rotation
                    }, 0, true);
                })
                .on('postgres_changes', { event: 'DELETE', schema: 'public', table: 'projects' }, (payload) => {
                    const id = payload.old.id;
                    const oldEl = container.querySelector('[data-id="' + id + '"]');
                    if (oldEl) oldEl.remove();
                    projectsData.delete(id);
                })
                .subscribe();

            sb.channel('members-realtime')
                .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'members' }, async () => {
                    const { data: dbMembers } = await sb.from('members').select('name, website').order('name');
                    if (dbMembers) renderMembers(dbMembers);
                })
                .subscribe();
        }

        // Auth-aware UI — set currentUserId before rendering, inject nav links
        async function checkAuth() {
            if (!sb) return;
            try {
                const { data: { session } } = await sb.auth.getSession();
                if (session) {
                    currentUserId = session.user.id;
                    const overlay = document.querySelector('.ui-overlay');

                    const submitBtn = document.createElement('a');
                    submitBtn.href = 'submit.html';
                    submitBtn.className = 'ui-btn';
                    submitBtn.innerHTML = '<svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg> Submit';
                    overlay.insertBefore(submitBtn, overlay.firstChild);

                    const profileBtn = document.createElement('a');
                    profileBtn.href = 'profile.html';
                    profileBtn.className = 'ui-btn';
                    profileBtn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg> Profile';
                    overlay.insertBefore(profileBtn, overlay.firstChild);
                }
            } catch(e) {}
        }

        // Edit modal
        function openEditModal(projectId) {
            const data = projectsData.get(projectId);
            if (!data) return;
            editImageFile = null;

            const overlay = document.createElement('div');
            overlay.className = 'edit-overlay';
            overlay.id = 'edit-overlay';
            overlay.addEventListener('click', function(e) { if (e.target === this) closeEditModal(); });

            const modal = document.createElement('div');
            modal.className = 'edit-modal';
            modal.addEventListener('click', function(e) { e.stopPropagation(); });
            modal.innerHTML = `
                <div class="edit-header">Edit project</div>
                <div class="edit-field">
                    <label>Title</label>
                    <input type="text" id="edit-title" maxlength="50">
                </div>
                <div class="edit-field">
                    <label>Description</label>
                    <textarea id="edit-desc" maxlength="120" rows="2"></textarea>
                </div>
                <div class="edit-field">
                    <label>Project link</label>
                    <input type="text" id="edit-url" placeholder="https://...">
                </div>
                <div class="edit-field">
                    <label>Image</label>
                    <div class="edit-image-row">
                        <img id="edit-image-thumb" class="edit-thumb" src="" alt="">
                        <label class="edit-change-btn" for="edit-image-file">Change image</label>
                        <input type="file" id="edit-image-file" accept="image/png,image/jpeg,image/gif" style="display:none">
                        <span style="font-size:0.6rem;color:rgba(0,0,0,0.25);">PNG, JPG, or GIF (animated OK)</span>
                    </div>
                </div>
                <div class="edit-actions">
                    <button class="edit-cancel" id="edit-cancel-btn">Cancel</button>
                    <button class="edit-save" id="edit-save-btn">Save changes</button>
                </div>
            `;
            overlay.appendChild(modal);
            document.body.appendChild(overlay);

            // Set values safely via DOM (no HTML injection)
            document.getElementById('edit-title').value = data.title || '';
            document.getElementById('edit-desc').value = data.desc || '';
            document.getElementById('edit-url').value = data.url || '';
            document.getElementById('edit-image-thumb').src = data.img || '';
            overlay.dataset.projectId = projectId;

            document.getElementById('edit-cancel-btn').addEventListener('click', closeEditModal);
            document.getElementById('edit-save-btn').addEventListener('click', saveEdit);
            document.getElementById('edit-image-file').addEventListener('change', function() {
                if (this.files && this.files[0]) {
                    editImageFile = this.files[0];
                    const reader = new FileReader();
                    reader.onload = (e) => { document.getElementById('edit-image-thumb').src = e.target.result; };
                    reader.readAsDataURL(editImageFile);
                }
            });

            // Focus title field
            document.getElementById('edit-title').focus();
        }

        function closeEditModal() {
            const overlay = document.getElementById('edit-overlay');
            if (overlay) overlay.remove();
            editImageFile = null;
        }

        async function saveEdit() {
            const overlay = document.getElementById('edit-overlay');
            if (!overlay) return;
            const projectId = overlay.dataset.projectId;
            const title = document.getElementById('edit-title').value.trim();
            const desc = document.getElementById('edit-desc').value.trim();
            const url = document.getElementById('edit-url').value.trim() || null;

            if (!title) { alert('Title is required.'); return; }

            const saveBtn = document.getElementById('edit-save-btn');
            saveBtn.disabled = true;
            saveBtn.textContent = 'Saving...';

            try {
                const updates = { title, description: desc, project_url: url };

                if (editImageFile) {
                    const ext = editImageFile.name.split('.').pop();
                    const path = currentUserId + '/' + Date.now() + '.' + ext;
                    const { error: uploadError } = await sb.storage
                        .from('project-images')
                        .upload(path, editImageFile);
                    if (uploadError) {
                        alert('Image upload failed: ' + uploadError.message);
                        saveBtn.disabled = false;
                        saveBtn.textContent = 'Save changes';
                        return;
                    }
                    const { data: urlData } = sb.storage.from('project-images').getPublicUrl(path);
                    updates.image_url = urlData.publicUrl;
                }

                const { error } = await sb
                    .from('projects')
                    .update(updates)
                    .eq('id', projectId)
                    .eq('member_id', currentUserId);

                if (error) {
                    alert('Save failed: ' + error.message);
                    saveBtn.disabled = false;
                    saveBtn.textContent = 'Save changes';
                    return;
                }

                // Update canvas immediately (realtime will also fire but handles gracefully)
                const oldData = projectsData.get(projectId);
                if (oldData) {
                    const oldEl = container.querySelector('[data-id="' + projectId + '"]');
                    if (oldEl) oldEl.remove();
                    renderObject({
                        ...oldData,
                        title: title,
                        desc: desc,
                        url: url || '',
                        img: updates.image_url || oldData.img
                    }, 0, true);
                }

                closeEditModal();
            } catch(e) {
                alert('Error: ' + e.message);
                saveBtn.disabled = false;
                saveBtn.textContent = 'Save changes';
            }
        }

        async function deleteProject(projectId) {
            if (!confirm('Delete this project? This cannot be undone.')) return;

            const { error } = await sb
                .from('projects')
                .delete()
                .eq('id', projectId)
                .eq('member_id', currentUserId);

            if (error) {
                alert('Delete failed: ' + error.message);
                return;
            }

            const el = container.querySelector('[data-id="' + projectId + '"]');
            if (el) el.remove();
            projectsData.delete(projectId);
        }

        // Navigate to a specific project if hash contains project coords
        function checkHashNavigation() {
            const hash = window.location.hash;
            if (!hash.startsWith('#project-')) return;
            const params = new URLSearchParams(hash.split('&').slice(1).join('&'));
            const x = parseFloat(params.get('x'));
            const y = parseFloat(params.get('y'));
            if (isNaN(x) || isNaN(y)) return;

            // Center viewport on project coordinates
            const vw = window.innerWidth / 2;
            const vh = window.innerHeight / 2;
            state.x = vw - x;
            state.y = vh - y;
            state.scale = 1;

            canvas.classList.add('is-animating');
            updateTransform();
            setTimeout(() => canvas.classList.remove('is-animating'), 550);

            // Highlight the project card briefly
            const projectId = hash.split('#project-')[1].split('&')[0];
            setTimeout(() => {
                const el = container.querySelector('[data-id="' + projectId + '"]');
                if (el) {
                    el.style.transition = 'box-shadow 0.3s ease';
                    el.style.boxShadow = '0 0 0 3px rgba(0,0,0,0.2)';
                    setTimeout(() => { el.style.boxShadow = ''; }, 2000);
                }
            }, 600);

            // Clean hash so refresh doesn't re-navigate
            history.replaceState(null, '', window.location.pathname);
        }

        // Init: check auth first (sets currentUserId), then load data
        (async () => {
            await checkAuth();
            await loadData();
            checkHashNavigation();
        })();

        // Hide login icon when user is already signed in (nav buttons visible)
        if (currentUserId) {
            const cs = document.getElementById('corner-secret');
            if (cs) cs.style.display = 'none';
        }

        // --- Pan & Zoom ---
        const viewport = document.getElementById('viewport');
        const canvas = document.getElementById('canvas');
        const zoomDisplay = document.getElementById('zoom-display');
        const centerBtn = document.getElementById('center-btn');
        const centerHub = document.getElementById('center-hub');

        const isMobile = window.innerWidth <= 600;
        let state = { x: 0, y: 0, scale: isMobile ? 0.65 : 1 };
        let isDragging = false;
        let dragStartX, dragStartY;
        let zoomTimeout;

        function updateTransform() {
            canvas.style.transform = `translate(${state.x}px, ${state.y}px) scale(${state.scale})`;
            zoomDisplay.textContent = Math.round(state.scale * 100) + '%';
            // Fade center hub text when zoomed out past 60%
            if (state.scale < 0.6) {
                const fadeAmount = Math.max(0, (state.scale - 0.3) / 0.3);
                centerHub.style.opacity = fadeAmount;
            } else {
                centerHub.style.opacity = 1;
            }
        }

        centerBtn.addEventListener('click', () => {
            canvas.classList.remove('is-zooming');
            canvas.classList.add('is-animating');
            state.x = 0; state.y = 0; state.scale = isMobile ? 0.65 : 1;
            updateTransform();
            setTimeout(() => canvas.classList.remove('is-animating'), 550);
        });

        function dismissHint() {
            const hint = document.getElementById('explore-hint');
            if (hint) hint.style.display = 'none';
        }

        viewport.addEventListener('mousedown', (e) => {
            if (e.target.closest('.ui-btn') || e.target.closest('.owner-controls')) return;
            isDragging = true;
            dismissHint();
            document.body.classList.add('is-dragging');
            canvas.classList.remove('is-zooming', 'is-animating');
            dragStartX = e.clientX - state.x;
            dragStartY = e.clientY - state.y;
        });

        window.addEventListener('mousemove', (e) => {
            if (!isDragging) return;
            state.x = e.clientX - dragStartX;
            state.y = e.clientY - dragStartY;
            requestAnimationFrame(updateTransform);
        });

        window.addEventListener('mouseup', () => { isDragging = false; document.body.classList.remove('is-dragging'); });

        viewport.addEventListener('wheel', (e) => {
            e.preventDefault();
            canvas.classList.remove('is-animating');
            const delta = -e.deltaY * 0.002;
            const newScale = Math.min(Math.max(0.2, state.scale * Math.exp(delta)), 2.5);
            if (newScale === state.scale) return;
            const rect = viewport.getBoundingClientRect();
            const mx = e.clientX - rect.left - rect.width / 2;
            const my = e.clientY - rect.top - rect.height / 2;
            state.x = mx - (mx - state.x) * (newScale / state.scale);
            state.y = my - (my - state.y) * (newScale / state.scale);
            state.scale = newScale;
            canvas.classList.add('is-zooming');
            requestAnimationFrame(updateTransform);
            clearTimeout(zoomTimeout);
            zoomTimeout = setTimeout(() => canvas.classList.remove('is-zooming'), 150);
        }, { passive: false });

        // Touch
        let lastTouchDist = 0;
        viewport.addEventListener('touchstart', (e) => {
            if (e.touches.length === 1) {
                isDragging = true;
                dismissHint();
                canvas.classList.remove('is-zooming', 'is-animating');
                dragStartX = e.touches[0].clientX - state.x;
                dragStartY = e.touches[0].clientY - state.y;
            } else if (e.touches.length === 2) {
                isDragging = false;
                const dx = e.touches[0].clientX - e.touches[1].clientX;
                const dy = e.touches[0].clientY - e.touches[1].clientY;
                lastTouchDist = Math.sqrt(dx*dx + dy*dy);
            }
        }, { passive: false });

        viewport.addEventListener('touchmove', (e) => {
            e.preventDefault();
            if (e.touches.length === 1 && isDragging) {
                state.x = e.touches[0].clientX - dragStartX;
                state.y = e.touches[0].clientY - dragStartY;
                requestAnimationFrame(updateTransform);
            } else if (e.touches.length === 2) {
                const dx = e.touches[0].clientX - e.touches[1].clientX;
                const dy = e.touches[0].clientY - e.touches[1].clientY;
                const dist = Math.sqrt(dx*dx + dy*dy);
                const sf = dist / lastTouchDist;
                const newScale = Math.min(Math.max(0.2, state.scale * sf), 2.5);
                const rect = viewport.getBoundingClientRect();
                const mx = (e.touches[0].clientX + e.touches[1].clientX) / 2 - rect.left - rect.width / 2;
                const my = (e.touches[0].clientY + e.touches[1].clientY) / 2 - rect.top - rect.height / 2;
                state.x = mx - (mx - state.x) * (newScale / state.scale);
                state.y = my - (my - state.y) * (newScale / state.scale);
                state.scale = newScale;
                lastTouchDist = dist;
                requestAnimationFrame(updateTransform);
            }
        }, { passive: false });

        viewport.addEventListener('touchend', () => { isDragging = false; });
        window.addEventListener('keydown', (e) => {
            if (e.key === '0') centerBtn.click();
            if (e.metaKey && e.shiftKey && e.key === 'k') {
                e.preventDefault();
                window.location.href = 'submit.html';
            }
        });

        updateTransform();
    </script>
</body>
</html>