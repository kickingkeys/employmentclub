<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Employment Club</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Caveat:wght@400;500;600;700&family=Inter:wght@300;400;500;600&family=Lora:ital,wght@0,400;0,500;1,400&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #f5f0eb;
            --text: #1a1a1a;
            --muted: #8a8178;
            --sans: 'Inter', system-ui, -apple-system, sans-serif;
            --serif: 'Lora', Georgia, serif;
            --hand: 'Caveat', cursive;
            --ease-out: cubic-bezier(0.16, 1, 0.3, 1);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; user-select: none; -webkit-user-drag: none; }

        body {
            background: var(--bg);
            color: var(--text);
            font-family: var(--sans);
            overflow: hidden;
            overscroll-behavior: none;
            width: 100vw; height: 100vh;
            cursor: grab;
        }

        body.is-dragging { cursor: grabbing !important; }
        body.is-dragging * { cursor: grabbing !important; }

        /* --- UI Overlay --- */
        .ui-overlay {
            position: fixed; bottom: 0; right: 0;
            z-index: 200; pointer-events: none;
            padding: 1.5rem;
            display: flex; gap: 8px; align-items: center;
        }

        .ui-btn {
            pointer-events: auto;
            background: rgba(255, 255, 255, 0.65);
            backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(0,0,0,0.05);
            border-radius: 10px;
            padding: 8px 14px;
            font-family: var(--sans);
            font-size: 0.72rem; font-weight: 600;
            color: var(--text); cursor: pointer;
            transition: all 0.25s var(--ease-out);
            display: flex; align-items: center; gap: 6px;
            font-variant-numeric: tabular-nums;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05), inset 0 0 0 1px rgba(255,255,255,0.4);
        }
        .ui-btn:hover {
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 6px 20px rgba(0,0,0,0.08), inset 0 0 0 1px rgba(255,255,255,0.5);
        }
        .ui-btn svg {
            width: 13px; height: 13px; fill: none;
            stroke: currentColor; stroke-width: 2;
            stroke-linecap: round; stroke-linejoin: round;
        }

        /* --- Viewport & Canvas --- */
        .viewport {
            width: 100vw; height: 100vh;
            position: absolute; top: 0; left: 0;
            background: radial-gradient(ellipse at center, #f8f4ef 0%, #ece5db 100%);
        }

        .canvas {
            position: absolute; top: 50%; left: 50%;
            will-change: transform;
        }
        .canvas.is-animating { transition: transform 0.5s var(--ease-out); }
        .canvas.is-zooming { transition: transform 0.12s cubic-bezier(0.2, 0, 0.2, 1); }

        /* Crisp dot grid */
        .canvas-bg {
            position: absolute;
            top: -10000px; left: -10000px;
            width: 20000px; height: 20000px;
            background-image: radial-gradient(circle, rgba(0,0,0,0.07) 1px, transparent 1px);
            background-size: 48px 48px;
            z-index: -1; pointer-events: none;
        }

        /* --- Center Hub --- */
        .center-hub {
            position: absolute; top: 0; left: 0;
            transform: translate(-50%, -50%);
            display: flex; flex-direction: column; align-items: center;
            text-align: center; width: 400px; z-index: 10;
            pointer-events: none;
            opacity: 0;
            animation: fadeInHub 1s 0.15s var(--ease-out) forwards;
            transition: opacity 0.4s ease;
        }

        .center-hub > * { pointer-events: auto; }

        .center-logo {
            width: 180px; height: auto;
            margin-bottom: 1rem;
            filter: drop-shadow(0 4px 12px rgba(0,0,0,0.04)) drop-shadow(0 20px 40px rgba(0,0,0,0.06));
            transition: transform 0.4s var(--ease-out);
        }
        .center-logo:hover { transform: scale(1.03); }

        .divider {
            width: 24px; height: 2px;
            background: #d4cfc9; border-radius: 2px;
            margin-bottom: 1.8rem;
        }

        .mission-desc {
            font-family: var(--serif); font-style: italic;
            font-size: 0.75rem; line-height: 1.6;
            color: rgba(0,0,0,0.45); max-width: 360px;
            letter-spacing: 0.1px; font-weight: 400;
            margin-bottom: 0;
        }

        .mission-attribution {
            font-family: var(--hand);
            font-size: 1.05rem;
            color: rgba(0,0,0,0.3);
            text-decoration: none;
            margin-top: 0.6rem;
            display: inline-block;
            transition: color 0.2s ease;
        }
        .mission-attribution:hover { color: rgba(0,0,0,0.55); }

        /* Members — clean editorial comma list */
        .members-label {
            font-family: var(--serif); font-style: italic;
            font-size: 0.75rem; font-weight: 400;
            letter-spacing: 0.1px;
            color: rgba(0,0,0,0.35); margin-bottom: 0.5rem;
        }

        .members-list {
            display: inline-flex; flex-wrap: wrap;
            justify-content: center; max-width: 400px;
            gap: 0;
        }

        .member {
            font-size: 0.82rem; color: var(--muted);
            padding: 0; background: none; border-radius: 0;
            text-decoration: none;
            transition: color 0.2s ease;
        }
        a.member { cursor: pointer; }
        .member:hover { color: var(--text); }
        .member-sep {
            font-size: 0.82rem; color: rgba(0,0,0,0.15);
            margin: 0 8px;
        }

        /* --- Floating Objects --- */
        .float-obj {
            position: absolute;
            opacity: 0;
            animation: enterObj 0.9s var(--ease-out) forwards;
            cursor: inherit;
            filter: drop-shadow(0 4px 12px rgba(0,0,0,0.04)) drop-shadow(0 20px 40px rgba(0,0,0,0.06));
            transition: filter 0.4s var(--ease-out), opacity 0.3s ease;
            will-change: transform, filter;
        }

        .float-obj:hover {
            z-index: 50;
            filter: drop-shadow(0 12px 24px rgba(0,0,0,0.06)) drop-shadow(0 32px 64px rgba(0,0,0,0.1));
        }

        /* Dim siblings on hover */
        #objects-container:hover .float-obj { opacity: 0.4; }
        #objects-container:hover .float-obj:hover { opacity: 1; }

        .float-img {
            width: 100%; height: auto; display: block;
            pointer-events: none;
            transition: transform 0.5s var(--ease-out);
        }
        .float-obj:hover .float-img {
            transform: rotate(1.5deg);
        }

        /* Etched-in-canvas label — title always visible, meta on hover */
        .float-info {
            position: relative;
            text-align: center;
            padding-top: 10px;
            pointer-events: none;
        }
        .float-info a { pointer-events: auto; }

        .float-title {
            font-family: var(--hand);
            font-size: 1.05rem; font-weight: 600;
            color: rgba(0,0,0,0.45);
            line-height: 1.1;
            transition: color 0.3s ease;
        }
        .float-obj:hover .float-title { color: rgba(0,0,0,0.65); }

        .float-meta {
            display: flex; align-items: center; justify-content: center; gap: 5px;
            margin-top: 2px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .float-obj:hover .float-meta { opacity: 1; }

        .float-desc {
            font-family: var(--sans);
            font-size: 0.55rem; font-weight: 500;
            color: rgba(0,0,0,0.25); letter-spacing: 0.2px;
        }

        .float-dot {
            width: 2px; height: 2px;
            border-radius: 50%; background: rgba(0,0,0,0.15);
            flex-shrink: 0;
        }

        .float-creator {
            font-family: var(--sans);
            font-size: 0.55rem; font-weight: 600;
            color: rgba(0,0,0,0.25);
            text-decoration: none;
        }
        a.float-creator:hover { color: rgba(0,0,0,0.45); }

        .float-link {
            display: inline-flex; align-items: center; gap: 3px;
            font-family: var(--sans);
            font-size: 0.5rem; font-weight: 600;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            color: rgba(0,0,0,0.15);
            text-decoration: none;
            margin-top: 5px;
            opacity: 0;
            transition: opacity 0.3s ease, color 0.2s ease;
        }
        .float-obj:hover .float-link { opacity: 1; }
        .float-link:hover { color: rgba(0,0,0,0.5); }
        .float-link svg { width: 8px; height: 8px; stroke: currentColor; fill: none; stroke-width: 2.5; }

        /* --- Animations --- */
        @keyframes fadeInHub {
            0% { opacity: 0; transform: translate(-50%, -46%) scale(0.94); }
            100% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        }

        @keyframes enterObj {
            0% { opacity: 0; transform: translate(var(--tx), var(--ty)) rotate(var(--rot)) scale(0.85); }
            100% { opacity: 1; transform: translate(var(--tx), var(--ty)) rotate(var(--rot)) scale(1); }
        }
    </style>
</head>
<body>

    <div class="ui-overlay">
        <div class="ui-btn" id="zoom-display">100%</div>
        <div class="ui-btn" id="center-btn" title="Back to center">
            <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M12 2v4M12 18v4M2 12h4M18 12h4"/></svg>
            Center
        </div>
    </div>

    <div class="viewport" id="viewport">
        <div class="canvas" id="canvas">
            <div class="canvas-bg"></div>

            <div class="center-hub" id="center-hub">
                <img src="logo.png" alt="Employment Club" class="center-logo">
                <div class="members-label">Members</div>
                <div class="members-list" id="members-list"></div>
                <p class="mission-desc" style="margin-top: 1.2rem;">This club is a space for my friends to work on projects together and put their work out to help land a job. Everyone here is incredibly talented, a tinkerer at heart, and attends the ITP program at NYU.</p>
                <a class="mission-attribution" href="https://surya.website" target="_blank">— Surya</a>
            </div>

            <div id="objects-container"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const SUPABASE_URL = 'https://pqzyhiyohiruvkjtqsii.supabase.co';
        const SUPABASE_KEY = 'sb_publishable__I5kMfVhw4D-LIfJiAdZMg_MZdj-ixV';

        let sb = null;
        try { sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY); } catch(e) {}

        const container = document.getElementById('objects-container');
        const membersList = document.getElementById('members-list');

        // Render members list
        function renderMembers(members) {
            membersList.innerHTML = '';
            members.forEach((m, i) => {
                const name = typeof m === 'string' ? m : m.name;
                const website = typeof m === 'string' ? null : m.website;
                if (website) {
                    const el = document.createElement('a');
                    el.className = 'member';
                    el.href = safeUrl(website);
                    el.target = '_blank';
                    el.rel = 'noopener noreferrer';
                    el.textContent = name;
                    membersList.appendChild(el);
                } else {
                    const el = document.createElement('span');
                    el.className = 'member';
                    el.textContent = name;
                    membersList.appendChild(el);
                }
                if (i < members.length - 1) {
                    const sep = document.createElement('span');
                    sep.className = 'member-sep';
                    sep.textContent = '\u00b7';
                    membersList.appendChild(sep);
                }
            });
        }

        // Escape HTML to prevent XSS
        function esc(str) {
            const d = document.createElement('div');
            d.textContent = str;
            return d.innerHTML;
        }

        // Sanitize URLs — only allow http/https
        function safeUrl(url) {
            if (!url) return '';
            const u = url.trim();
            if (u.startsWith('http://') || u.startsWith('https://')) return u;
            if (u.startsWith('javascript:') || u.startsWith('data:')) return '';
            return 'https://' + u;
        }

        // Render a single floating object on the canvas
        function renderObject(obj, delay) {
            const el = document.createElement('div');
            el.className = 'float-obj';
            if (obj.id) el.dataset.id = obj.id;
            el.style.width = (obj.w || obj.width || 250) + 'px';
            const x = obj.x || obj.canvas_x || 0;
            const y = obj.y || obj.canvas_y || 0;
            const rot = obj.rot || obj.rotation || 0;
            el.style.setProperty('--tx', x + 'px');
            el.style.setProperty('--ty', y + 'px');
            el.style.setProperty('--rot', rot + 'deg');
            el.style.left = -(obj.w || obj.width || 250) / 2 + 'px';
            el.style.top = '-80px';
            el.style.transform = `translate(${x}px, ${y}px) rotate(${rot}deg)`;
            el.style.animationDelay = delay + 's';

            const imgSrc = esc(obj.img || obj.image_url || '');
            const title = esc(obj.title || '');
            const desc = esc(obj.desc || obj.description || '');
            const creator = esc(obj.creator || obj.member_name || '');
            const url = safeUrl(obj.url || obj.project_url || '');
            const creatorWebsite = safeUrl(obj.creator_website || '');

            const linkHtml = url ? `<a class="float-link" href="${url}" target="_blank" rel="noopener noreferrer">View project <svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><line x1="7" y1="17" x2="17" y2="7"/><polyline points="7 7 17 7 17 17"/></svg></a>` : '';

            const creatorHtml = creatorWebsite
                ? `<a class="float-creator" href="${creatorWebsite}" target="_blank" rel="noopener noreferrer">${creator}</a>`
                : `<span class="float-creator">${creator}</span>`;

            el.innerHTML = `
                <img class="float-img" src="${imgSrc}" alt="${title}">
                <div class="float-info">
                    <div class="float-title">${title}</div>
                    <div class="float-meta">
                        <span class="float-desc">${desc}</span>
                        <span class="float-dot"></span>
                        ${creatorHtml}
                    </div>
                    ${linkHtml}
                </div>
            `;
            container.appendChild(el);
            return el;
        }

        // Load data from Supabase
        async function loadData() {
            if (!sb) return;

            try {
                // Fetch members
                const { data: dbMembers } = await sb.from('members').select('name, website').order('name');
                if (dbMembers && dbMembers.length > 0) {
                    renderMembers(dbMembers);
                }

                // Fetch projects with member info
                const { data: dbProjects } = await sb
                    .from('projects')
                    .select('*, members(name, website)')
                    .order('created_at');

                if (dbProjects && dbProjects.length > 0) {
                    dbProjects.forEach((p, i) => {
                        renderObject({
                            id: p.id,
                            img: p.image_url,
                            title: p.title,
                            desc: p.description,
                            url: p.project_url,
                            creator: p.members?.name || '',
                            creator_website: p.members?.website || '',
                            w: p.width,
                            x: p.canvas_x,
                            y: p.canvas_y,
                            rot: p.rotation
                        }, 0.3 + i * 0.06);
                    });
                }
            } catch(e) {
                console.log('Supabase fetch failed', e);
            }

            // Subscribe to realtime inserts
            sb.channel('projects-realtime')
                .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'projects' }, async (payload) => {
                    const p = payload.new;
                    const { data: member } = await sb.from('members').select('name, website').eq('id', p.member_id).single();
                    renderObject({
                        id: p.id,
                        img: p.image_url,
                        title: p.title,
                        desc: p.description,
                        url: p.project_url,
                        creator: member?.name || '',
                        creator_website: member?.website || '',
                        w: p.width,
                        x: p.canvas_x,
                        y: p.canvas_y,
                        rot: p.rotation
                    }, 0);
                })
                .subscribe();

            sb.channel('members-realtime')
                .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'members' }, async () => {
                    const { data: dbMembers } = await sb.from('members').select('name, website').order('name');
                    if (dbMembers) renderMembers(dbMembers);
                })
                .subscribe();
        }

        loadData();

        // --- Pan & Zoom ---
        const viewport = document.getElementById('viewport');
        const canvas = document.getElementById('canvas');
        const zoomDisplay = document.getElementById('zoom-display');
        const centerBtn = document.getElementById('center-btn');
        const centerHub = document.getElementById('center-hub');

        let state = { x: 0, y: 0, scale: 1 };
        let isDragging = false;
        let dragStartX, dragStartY;
        let zoomTimeout;

        function updateTransform() {
            canvas.style.transform = `translate(${state.x}px, ${state.y}px) scale(${state.scale})`;
            zoomDisplay.textContent = Math.round(state.scale * 100) + '%';
            // Fade center hub text when zoomed out past 60%
            if (state.scale < 0.6) {
                const fadeAmount = Math.max(0, (state.scale - 0.3) / 0.3);
                centerHub.style.opacity = fadeAmount;
            } else {
                centerHub.style.opacity = 1;
            }
        }

        centerBtn.addEventListener('click', () => {
            canvas.classList.remove('is-zooming');
            canvas.classList.add('is-animating');
            state.x = 0; state.y = 0; state.scale = 1;
            updateTransform();
            setTimeout(() => canvas.classList.remove('is-animating'), 550);
        });

        viewport.addEventListener('mousedown', (e) => {
            if (e.target.closest('.ui-btn')) return;
            isDragging = true;
            document.body.classList.add('is-dragging');
            canvas.classList.remove('is-zooming', 'is-animating');
            dragStartX = e.clientX - state.x;
            dragStartY = e.clientY - state.y;
        });

        window.addEventListener('mousemove', (e) => {
            if (!isDragging) return;
            state.x = e.clientX - dragStartX;
            state.y = e.clientY - dragStartY;
            requestAnimationFrame(updateTransform);
        });

        window.addEventListener('mouseup', () => { isDragging = false; document.body.classList.remove('is-dragging'); });

        viewport.addEventListener('wheel', (e) => {
            e.preventDefault();
            canvas.classList.remove('is-animating');
            const delta = -e.deltaY * 0.002;
            const newScale = Math.min(Math.max(0.2, state.scale * Math.exp(delta)), 2.5);
            if (newScale === state.scale) return;
            const rect = viewport.getBoundingClientRect();
            const mx = e.clientX - rect.left - rect.width / 2;
            const my = e.clientY - rect.top - rect.height / 2;
            state.x = mx - (mx - state.x) * (newScale / state.scale);
            state.y = my - (my - state.y) * (newScale / state.scale);
            state.scale = newScale;
            canvas.classList.add('is-zooming');
            requestAnimationFrame(updateTransform);
            clearTimeout(zoomTimeout);
            zoomTimeout = setTimeout(() => canvas.classList.remove('is-zooming'), 150);
        }, { passive: false });

        // Touch
        let lastTouchDist = 0;
        viewport.addEventListener('touchstart', (e) => {
            if (e.touches.length === 1) {
                isDragging = true;
                canvas.classList.remove('is-zooming', 'is-animating');
                dragStartX = e.touches[0].clientX - state.x;
                dragStartY = e.touches[0].clientY - state.y;
            } else if (e.touches.length === 2) {
                isDragging = false;
                const dx = e.touches[0].clientX - e.touches[1].clientX;
                const dy = e.touches[0].clientY - e.touches[1].clientY;
                lastTouchDist = Math.sqrt(dx*dx + dy*dy);
            }
        }, { passive: false });

        viewport.addEventListener('touchmove', (e) => {
            e.preventDefault();
            if (e.touches.length === 1 && isDragging) {
                state.x = e.touches[0].clientX - dragStartX;
                state.y = e.touches[0].clientY - dragStartY;
                requestAnimationFrame(updateTransform);
            } else if (e.touches.length === 2) {
                const dx = e.touches[0].clientX - e.touches[1].clientX;
                const dy = e.touches[0].clientY - e.touches[1].clientY;
                const dist = Math.sqrt(dx*dx + dy*dy);
                const sf = dist / lastTouchDist;
                const newScale = Math.min(Math.max(0.2, state.scale * sf), 2.5);
                const rect = viewport.getBoundingClientRect();
                const mx = (e.touches[0].clientX + e.touches[1].clientX) / 2 - rect.left - rect.width / 2;
                const my = (e.touches[0].clientY + e.touches[1].clientY) / 2 - rect.top - rect.height / 2;
                state.x = mx - (mx - state.x) * (newScale / state.scale);
                state.y = my - (my - state.y) * (newScale / state.scale);
                state.scale = newScale;
                lastTouchDist = dist;
                requestAnimationFrame(updateTransform);
            }
        }, { passive: false });

        viewport.addEventListener('touchend', () => { isDragging = false; });
        window.addEventListener('keydown', (e) => { if (e.key === '0') centerBtn.click(); });

        updateTransform();
    </script>
</body>
</html>